<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook</title>
    <th:block th:replace="~{fragments/commonHead :: commonHead}"></th:block>
    <link rel="stylesheet" th:href="@{/css/news-feed.css}">
    <style>
        .like-btn.liked {
            color: #3b7cfd;
        }
        </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="main-container">
    <div class="sidebar">
        <h3><i class="fas fa-user"></i> Hồ sơ của tôi</h3>
        <div class="user-profile">
            <div class="avatar">
                <span th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">U</span>
            </div>
            <h4 th:text="${#authentication.principal.fullName}">Tên người dùng</h4>
            <p class="user-role">Thành viên mới</p>
        </div>

        <hr class="divider">

        <h3><i class="fas fa-chart-line"></i> Thống kê</h3>
        <div class="stats">
            <p><i class="fas fa-users"></i> 0 bạn bè</p>
            <p><i class="fas fa-edit"></i> 0 bài viết</p>
            <p><i class="fas fa-heart"></i> 0 lượt thích</p>
        </div>
    </div>

    <!-- Main Feed -->
    <div class="feed">
        <!-- Post Creator -->
        <div class="post-creator">
            <h3 class="post-title">
                <i class="fas fa-pen"></i> Bạn đang nghĩ gì?
            </h3>
            <form>
                <textarea class="form-control" rows="3" placeholder="Chia sẻ suy nghĩ của bạn..."></textarea>
                <div class="post-options">
                    <div>
                        <button type="button" class="action-btn">
                            <i class="fas fa-image"></i> Ảnh
                        </button>
                        <button type="button" class="action-btn">
                            <i class="fas fa-video"></i> Video
                        </button>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> Đăng
                    </button>
                </div>
            </form>
        </div>

        <!-- Sample Posts -->
        <div th:each="status : ${statuses}" class="post">
            <div class="post-header"></div>

            <div class="post-content">
                <p th:text="${status.content}" >Chào mừng bạn đến với mạng xã hội của chúng tôi</p>
            </div>
            <div class="post-actions">
                <button class="action-btn  like-btn"
                        th:data-status-id="${status.id}"
                        th:classappend="${status.currentUserIsLiked} ? 'liked' : ''">
                    <i class="fas fa-heart"></i> Thích (<span class="like-count" th:text="${status.likeCount}"></span>)
                </button>
                <button class="action-btn">
                    <i class="fas fa-comment"></i> Bình luận (0)
                </button>
                <button class="action-btn">
                    <i class="fas fa-share"></i> Chia sẻ (0)
                </button>
            </div>
        </div>


    </div>

    <!-- Right Sidebar -->
    <div class="sidebar">
        <h3><i class="fas fa-users"></i> Gợi ý kết bạn</h3>
        <p class="text-muted">
            Chưa có gợi ý nào.<br>
            Hãy mời bạn bè tham gia!
        </p>

        <hr class="divider">

        <h3><i class="fas fa-fire"></i> Xu hướng</h3>
        <div class="trending">
            <p>#ChaoMung</p>
            <p>#SocialMedia</p>
            <p>#KetNoi</p>
        </div>
    </div>
</div>

<script>
    // Kết nối WebSocket
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        // Subscribe vào các topic cần thiết
        document.querySelectorAll('.post').forEach(post => {
            const statusId = post.querySelector('.like-btn').getAttribute('data-status-id');
            stompClient.subscribe('/topic/status/' + statusId + '/likes', function(message) {
                const data = JSON.parse(message.body);
                console.log('Dữ liệu data: ')
                console.log(data)
                updateLikeUI(data.statusId, data.likeCount, data.isLiked);
            });
        });
    });


    function updateLikeUI(statusId, likeCount, isLiked) {
        const likeBtn = document.querySelector(`.like-btn[data-status-id="${statusId}"]`);
        if (likeBtn) {
            likeBtn.querySelector('.like-count').textContent = likeCount;

            if (isLiked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }
    }



    // Xử lý sự kiện like
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const statusId = this.getAttribute('data-status-id');

            try {
                const response = await fetch(`/api/likes/status/${statusId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Cập nhật giao diện
                    this.classList.toggle('liked');
                    this.querySelector('.like-count').textContent = data.likeCount;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });
</script>
</body>
</html>
