<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook</title>
    <th:block th:replace="~{fragments/commonHead :: commonHead}"></th:block>
    <link rel="stylesheet" th:href="@{/css/news-feed.css}">
    <style>
        .like-btn.liked {
            color: #3b7cfd;
        }

        .friend-item {
            display: flex;
            align-items: center;
            background-color: #b1a0a0; /* màu nền tối */
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 6px;
            color: white;
            font-family: sans-serif;
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }

        .friend-item:hover {
            background-color: #3a3a3a;
            transform: translateY(-3px);
        }

        .friend-name {
            font-size: 14px;
            font-weight: 500;
        }

        .chat-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            display: none; /* Ẩn mặc định */
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chat-box-header {
            padding: 10px;
            background: #007bff;
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .chat-box-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        .chat-box-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
        }
        .chat-box-input input {
            flex: 1;
            padding: 5px;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="main-container">
    <div class="sidebar">
        <h3><i class="fas fa-user"></i> Hồ sơ của tôi</h3>
        <div class="user-profile">
            <div class="avatar">
                <span th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">U</span>
            </div>
            <h4 th:text="${#authentication.principal.fullName}">Tên người dùng</h4>
            <p class="user-role">Thành viên mới</p>
        </div>

        <hr class="divider">

        <h3><i class="fas fa-chart-line"></i> Thống kê</h3>
        <div class="stats">
            <p><i class="fas fa-users"></i> 0 bạn bè</p>
            <p><i class="fas fa-edit"></i> 0 bài viết</p>
            <p><i class="fas fa-heart"></i> 0 lượt thích</p>
        </div>
    </div>

    <!-- Main Feed -->
    <div class="feed">
        <!-- Post Creator -->
        <div class="post-creator">
            <h3 class="post-title">
                <i class="fas fa-pen"></i> Bạn đang nghĩ gì?
            </h3>
            <form>
                <textarea class="form-control" rows="3" placeholder="Chia sẻ suy nghĩ của bạn..."></textarea>
                <div class="post-options">
                    <div>
                        <button type="button" class="action-btn">
                            <i class="fas fa-image"></i> Ảnh
                        </button>
                        <button type="button" class="action-btn">
                            <i class="fas fa-video"></i> Video
                        </button>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> Đăng
                    </button>
                </div>
            </form>
        </div>

        <!-- Posts -->
        <div th:each="status : ${statuses}" class="post">
            <div class="post-header"></div>

            <div class="post-content">
                <p th:text="${status.content}">Chào mừng bạn đến với mạng xã hội của chúng tôi</p>
            </div>
            <div class="post-actions">
                <button class="action-btn  like-btn"
                        th:data-status-id="${status.id}"
                        th:classappend="${status.currentUserIsLiked} ? 'liked' : ''">
                    <i class="fas fa-heart"></i> Thích (<span class="like-count" th:text="${status.likeCount}"></span>)
                </button>
                <button class="action-btn">
                    <i class="fas fa-comment"></i> Bình luận (0)
                </button>
                <button class="action-btn">
                    <i class="fas fa-share"></i> Chia sẻ (0)
                </button>
            </div>
        </div>


    </div>

    <!-- Right Sidebar -->
    <div class="sidebar">
        <h5><i class="fas fa-users"></i> Người liên hệ</h5>
        <div class="friend-item" th:each="friend : ${friends}"
             th:attr="data-friend-id=${friend.id},data-friend-name=${friend.firstName + ' ' + friend.lastName}">
            <img th:if="${friend.profilePicture != null and !#strings.isEmpty(friend.profilePicture)}"
                 th:src="${friend.profilePicture}" alt="Avatar"
                 class="rounded-circle nav-icon-wrapper me-3"/>

            <img th:unless="${friend.profilePicture != null and !#strings.isEmpty(friend.profilePicture)}"
                 th:src="@{/images/default-avatar.jpg}" alt="Avatar"
                 class="rounded-circle nav-icon-wrapper me-3"/>


<!--            <img th:src="${friend.profilePicture}" alt="Avatar">-->
            <span th:text="${friend.firstName + ' ' + friend.lastName}"></span>
        </div>

        <hr class="divider">

        <h5><i class="fas fa-fire"></i> Nhóm</h5>
        <div>
            <p>#ChaoMung</p>
            <p>#SocialMedia</p>
            <p>#KetNoi</p>
        </div>
    </div>
</div>

<div id="chatBox" class="chat-box">
    <div class="chat-box-header" id="chatHeader">Chat</div>
    <div class="chat-box-messages" id="chatMessages">
        <!-- Tin nhắn sẽ load ở đây -->
    </div>
    <div class="chat-box-input">
        <input type="text" id="chatInput" placeholder="Nhập tin nhắn...">
        <button id="sendBtn">Gửi</button>
    </div>
</div>

<script th:inline="javascript">

    document.querySelectorAll('.friend-item').forEach(item => {
        item.addEventListener('click', function() {
            const friendId = this.getAttribute('data-friend-id');
            const friendName = this.getAttribute('data-friend-name');

            // Cập nhật tiêu đề khung chat
            document.getElementById('chatHeader').textContent = friendName;

            // Hiện khung chat
            document.getElementById('chatBox').style.display = 'flex';

            // Ở đây bạn có thể gọi API để load lịch sử chat theo friendId
            console.log("Open chat with:", friendId);
        });
    });





    const currentUser = [[${#authentication.principal.username}]];

    // Kết nối WebSocket
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);

        // Subscribe vào các topic cần thiết
        document.querySelectorAll('.post').forEach(post => {
            const statusId = post.querySelector('.like-btn').getAttribute('data-status-id');
            stompClient.subscribe('/topic/status/' + statusId + '/likes', function (message) {
                const data = JSON.parse(message.body);
                if (data.userName === currentUser) {
                    // Chính mình click => update cả likeCount và class .liked
                    updateLikeUI(data.statusId, data.likeCount, data.isLiked);
                } else {
                    // Người khác click => chỉ update số lượng like
                    const btn = document.querySelector(`.like-btn[data-status-id="${data.statusId}"]`);
                    if (btn) {
                        btn.querySelector('.like-count').textContent = data.likeCount;
                    }
                }
            });
        });
    });


    function updateLikeUI(statusId, likeCount, isLiked) {
        const likeBtn = document.querySelector(`.like-btn[data-status-id="${statusId}"]`);
        if (likeBtn) {
            likeBtn.querySelector('.like-count').textContent = likeCount;

            if (isLiked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }
    }

    // Xử lý sự kiện like
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            const statusId = this.getAttribute('data-status-id');

            try {
                const response = await fetch(`/api/likes/status/${statusId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // Không toggle ở đây nữa, chỉ cập nhật bằng server response
                    updateLikeUI(data.statusId, data.likeCount, data.isLiked);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });

</script>
</body>
</html>
