<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>News Feed - Social Media</title>
  <th:block th:replace="~{fragments/commonHead :: commonHead}"></th:block>
  <link rel="stylesheet" th:href="@{/css/news-feed.css}">
  <style>
    body { padding-top: 70px; }
    .status-input { background-color: #f0f2f5; border: none; border-radius: 50px; padding: 12px 16px; cursor: pointer; width: 100%; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
    .profile-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; }
    .action-btn { border: none; background: none; color: #65676b; font-weight: 500; padding: 8px; border-radius: 6px; transition: all 0.2s; cursor: pointer; }
    .action-btn:hover { background-color: #f0f2f5; }
    .action-btn.text-primary { color: #1877f2 !important; }
    .author-name { color: #050505; cursor: pointer; text-decoration: none; font-weight: 600; }
    .author-name:hover { text-decoration: underline; }
    .post-image { cursor: pointer; transition: transform 0.2s; }
    .post-image:hover { transform: scale(1.02); }
    .h-200 { height: 200px !important; object-fit: cover; }
  </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid">
  <!-- Success/Error Messages -->
  <div th:if="${success}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
    <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
    <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="row">
    <!-- Left Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
      <div class="left-sidebar sticky-top" style="top: 80px;">
        <!-- User Info -->
        <div class="sidebar-section" sec:authorize="isAuthenticated()">
          <div class="user-profile-card d-flex align-items-center">
            <img th:if="${currentUser?.profilePicture}"
                 th:src="@{${currentUser.profilePicture}}"
                 alt="Avatar" class="profile-img me-3">
            <img th:unless="${currentUser?.profilePicture}"
                 th:src="@{/images/default-avatar.jpg}"
                 alt="Avatar" class="profile-img me-3">
            <div class="user-info">
              <h6 th:text="${currentUser?.firstName + ' ' + currentUser?.lastName}">Tên người dùng</h6>
              <small class="text-muted" sec:authentication="name">username</small>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <div class="sidebar-section">
          <div class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>News Feed</span>
          </div>
          <div class="nav-item">
            <i class="fas fa-user-friends nav-icon"></i>
            <span>Bạn bè</span>
          </div>
          <div class="nav-item">
            <i class="fas fa-users nav-icon"></i>
            <span>Nhóm</span>
          </div>
          <div class="nav-item">
            <i class="fas fa-store nav-icon"></i>
            <span>Marketplace</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-6">
      <!-- Status Creator -->
      <div class="card mb-3" sec:authorize="isAuthenticated()">
        <div class="card-body">
          <div class="status-header d-flex align-items-center mb-3">
            <img th:if="${currentUser?.profilePicture}"
                 th:src="@{${currentUser.profilePicture}}"
                 alt="Avatar" class="post-avatar me-3">
            <img th:unless="${currentUser?.profilePicture}"
                 th:src="@{/images/default-avatar.jpg}"
                 alt="Avatar" class="post-avatar me-3">

            <input type="text" class="form-control status-input"
                   placeholder="Bạn đang nghĩ gì?" readonly
                   data-bs-toggle="modal" data-bs-target="#statusModal">
          </div>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-around">
            <button type="button" class="btn btn-light d-flex align-items-center flex-fill me-1"
                    data-bs-toggle="modal" data-bs-target="#statusModal">
              <i class="fas fa-images text-success me-2"></i>
              <span>Ảnh/Video</span>
            </button>
            <button type="button" class="btn btn-light d-flex align-items-center flex-fill mx-1">
              <i class="fas fa-smile text-warning me-2"></i>
              <span>Cảm xúc</span>
            </button>
            <button type="button" class="btn btn-light d-flex align-items-center flex-fill ms-1">
              <i class="fas fa-map-marker-alt text-danger me-2"></i>
              <span>Check in</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Status Feed -->
      <div class="status-feed">
        <!-- Status Posts -->
        <div th:if="${statuses != null && !statuses.isEmpty()}">
          <div class="card mb-3" th:each="status : ${statuses.content}">
            <!-- Post Header -->
            <div class="card-header bg-white border-0 pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <img th:if="${status.userAvatar != null}" th:src="@{${status.userAvatar}}"
                       alt="Avatar" class="post-avatar me-3">
                  <img th:unless="${status.userAvatar != null}" th:src="@{/images/default-avatar.jpg}"
                       alt="Avatar" class="post-avatar me-3">
                  alt="Avatar" class="post-avatar me-3">
                  <div>
                    <h6 class="mb-0 fw-bold author-name" th:text="${status.userFullName}">Tên tác giả</h6>
                    <small class="text-muted d-flex align-items-center">
                      <span th:text="${status.timeAgo}">2 giờ trước</span>
                      <span class="mx-1">·</span>
                      <i class="fas fa-globe-americas"></i>
                    </small>
                  </div>
                </div>

                <!-- Options Menu -->
                <div class="dropdown" th:if="${status.userId == currentUserId}">
                  <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" th:href="@{'/status/edit/' + ${status.id}}">
                        <i class="fas fa-edit me-2"></i>Chỉnh sửa
                      </a>
                    </li>
                    <li>
                      <form th:action="@{'/status/toggle-pin/' + ${status.id}}" method="post" class="d-inline">
                        <button type="submit" class="dropdown-item">
                          <i class="fas fa-thumbtack me-2"></i>
                          <span th:text="${status.pinned} ? 'Bỏ ghim' : 'Ghim bài viết'">Ghim</span>
                        </button>
                      </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <form th:action="@{'/status/delete/' + ${status.id}}" method="post"
                            class="d-inline" onsubmit="return confirm('Bạn có chắc muốn xóa?')">
                        <button type="submit" class="dropdown-item text-danger">
                          <i class="fas fa-trash me-2"></i>Xóa
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Pinned Badge -->
            <div class="px-3 py-1" th:if="${status.pinned}">
              <small class="text-warning">
                <i class="fas fa-thumbtack me-1"></i>
                Bài viết đã ghim
              </small>
            </div>

            <!-- Post Content -->
            <div class="card-body pt-2">
              <p class="mb-3" th:text="${status.content}">Nội dung bài viết</p>

              <!-- Images -->
              <div class="post-images mb-3" th:if="${status.imageUrls != null && !status.imageUrls.isEmpty()}">
                <div class="row g-2" th:switch="${status.imageUrls.size()}">
                  <div th:case="1" class="col-12">
                    <img th:src="@{${status.imageUrls[0]}}" alt="Post image"
                         class="img-fluid rounded post-image">
                  </div>

                  <div th:case="*" th:each="imageUrl, iterStat : ${status.imageUrls}"
                       th:class="${iterStat.index < 2} ? 'col-6' : 'd-none'">
                    <img th:src="@{${imageUrl}}" alt="Post image"
                         class="img-fluid rounded post-image h-200">
                  </div>
                </div>
              </div>

              <!-- Video -->
              <div class="mb-3" th:if="${status.videoUrl}">
                <video controls class="w-100 rounded">
                  <source th:src="@{${status.videoUrl}}" type="video/mp4">
                </video>
              </div>
            </div>

            <!-- Post Stats -->
            <div class="px-3 py-1" th:if="${status.likeCount > 0 || status.commentCount > 0}">
              <div class="d-flex justify-content-between text-muted small">
                <div th:if="${status.likeCount > 0}">
                  <i class="fas fa-thumbs-up text-primary me-1"></i>
                  <span th:text="${status.likeCount}">0</span>
                </div>
                <div>
                                        <span th:if="${status.commentCount > 0}"
                                              th:text="${status.commentCount + ' bình luận'}"></span>
                </div>
              </div>
            </div>

            <!-- Post Actions -->
            <div class="card-footer bg-white border-0 pt-0">
              <div class="d-flex justify-content-around">
                <button class="btn btn-light flex-fill me-1 action-btn"
                        th:classappend="${status.liked} ? 'text-primary' : ''">
                  <i class="fas fa-thumbs-up me-1"></i>
                  <span>Thích</span>
                </button>

                <button class="btn btn-light flex-fill mx-1 action-btn">
                  <i class="fas fa-comment me-1"></i>
                  <span>Bình luận</span>
                </button>

                <button class="btn btn-light flex-fill ms-1 action-btn">
                  <i class="fas fa-share me-1"></i>
                  <span>Chia sẻ</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- No Posts Message -->
        <div th:if="${statuses == null || statuses.isEmpty()}" class="text-center py-5">
          <div class="card">
            <div class="card-body">
              <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">Chưa có bài viết nào</h5>
              <p class="text-muted">Hãy tạo bài viết đầu tiên!</p>
            </div>
          </div>
        </div>

        <!-- Load More -->
        <div class="text-center my-4" th:if="${hasNext}">
          <a th:href="@{/status/news-feed(page=${currentPage + 1})}" class="btn btn-outline-primary">
            Xem thêm bài viết
          </a>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
      <div class="right-sidebar sticky-top" style="top: 80px;">
        <div class="sidebar-section">
          <h6 class="fw-bold mb-3">Người liên hệ</h6>
          <p class="text-muted small">Chưa có bạn bè online</p>
        </div>

        <div class="sidebar-section">
          <h6 class="fw-bold mb-3">Gợi ý kết bạn</h6>
          <p class="text-muted small">Chưa có gợi ý nào</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status Creation Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tạo bài viết</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form th:action="@{/status/create}" method="post" enctype="multipart/form-data"
            th:object="${statusCreateDto}">
        <div class="modal-body">
          <!-- User Info -->
          <div class="d-flex align-items-center mb-3" sec:authorize="isAuthenticated()">
            <img th:if="${currentUser?.profilePicture}"
                 th:src="@{${currentUser.profilePicture}}"
                 alt="Avatar" class="rounded-circle me-2" width="40" height="40">
            <img th:unless="${currentUser?.profilePicture}"
                 th:src="@{/images/default-avatar.jpg}"
                 alt="Avatar" class="rounded-circle me-2" width="40" height="40">
            <div>
              <h6 class="mb-0" th:text="${currentUser?.firstName + ' ' + currentUser?.lastName}">Tên</h6>
              <select class="form-select form-select-sm mt-1" name="privacyLevel">
                <option value="PUBLIC">🌍 Công khai</option>
                <option value="FRIENDS">👥 Bạn bè</option>
                <option value="ONLY_ME">🔒 Chỉ mình tôi</option>
              </select>
            </div>
          </div>

          <!-- Content Input -->
          <textarea class="form-control border-0 mb-3" name="content" rows="4"
                    placeholder="Bạn đang nghĩ gì?" required></textarea>

          <!-- File Upload -->
          <div class="border rounded p-2">
            <div class="d-flex justify-content-between align-items-center">
              <small class="fw-bold">Thêm vào bài viết</small>
              <div>
                <label class="btn btn-light btn-sm">
                  <i class="fas fa-images text-success"></i>
                  <input type="file" name="images" multiple accept="image/*" style="display: none;">
                </label>
                <label class="btn btn-light btn-sm">
                  <i class="fas fa-video text-danger"></i>
                  <input type="file" name="video" accept="video/*" style="display: none;">
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100">Đăng</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Auto-hide alerts
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(alert => {
        if (alert.classList.contains('show')) {
          bootstrap.Alert.getOrCreateInstance(alert).close();
        }
      });
    }, 5000);
  });
</script>
</body>
</html>