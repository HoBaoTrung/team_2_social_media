<!-- C·∫≠p nh·∫≠t file profile/view.html ƒë·ªÉ t√≠ch h·ª£p posts -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${user.firstName + ' ' + user.lastName + ' | H·ªì s∆° c√° nh√¢n'}">Trang c√° nh√¢n</title>
    <link rel="stylesheet" th:href="@{/css/view_profile.css}">
    <link rel="stylesheet" th:href="@{/css/friend_card.css}">
    <link rel="stylesheet" th:href="@{/css/post.css}">
    <th:block th:replace="~{fragments/commonHead :: commonHead}"></th:block>
</head>
<body>

<!-- HEADER -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- COVER IMAGE + AVATAR -->
<div class="cover-container">
    <img class="cover-image" th:src="@{/images/default-avatar.jpg}" alt="·∫¢nh b√¨a">
    <div class="avatar-container">
        <img class="avatar"
             th:if="${user.profilePicture != null and !#strings.isEmpty(user.profilePicture)}"
             th:src="@{${user.profilePicture}}" alt="Avatar">
        <img class="avatar"
             th:unless="${user.profilePicture != null and !#strings.isEmpty(user.profilePicture)}"
             th:src="@{/images/default-avatar.jpg}" alt="Avatar">
        <div class="user-name" th:text="${user.firstName + ' ' + user.lastName}">T√™n ng∆∞·ªùi d√πng</div>
        <div class="button-group" th:if="${!isOwner}">
            <div th:insert="fragments/friend-button-group :: buttonGroup(${user.username}, ${friendshipStatus}, ${isSender}, ${isReceiver}, ${allowFriendRequests},false)"></div>
            <button th:if="${canSendMessage}" class="btn btn-primary">
                <i class="fa-solid fa-message"></i> Nh·∫Øn tin
            </button>
        </div>
    </div>
</div>

<!-- NAVIGATION TABS -->
<div class="profile-tabs">
    <a th:href="@{'/profile/' + ${user.username} + '?filter=posts'}"
       th:classappend="${filter == 'posts'} ? 'active' : ''"
       class="tab">B√†i vi·∫øt</a>
    <a th:href="@{'/profile/' + ${user.username} + '?filter=photos'}"
       th:classappend="${filter == 'photos'} ? 'active' : ''"
       class="tab">·∫¢nh</a>
    <a th:href="@{'/profile/' + ${user.username} + '?filter=all'}"
       th:classappend="${filter == 'all'} ? 'active' : ''"
       class="tab"
       th:if="${canViewFriendList}">B·∫°n b√®</a>
    <a th:href="@{'/profile/' + ${user.username} + '?filter=mutual'}"
       th:classappend="${filter == 'mutual'} ? 'active' : ''"
       class="tab"
       th:if="${!isOwner and mutualFriendsCount>0}">B·∫°n chung</a>
</div>

<!-- MAIN CONTENT -->
<div class="profile-page-container d-flex">
    <!-- C·ªòT TR√ÅI: Th√¥ng tin ng∆∞·ªùi d√πng -->
    <div th:if="${filter == 'posts' or filter == 'photos' }" class="profile-left-column">
        <div class="card-box profile-content">
            <h2>Th√¥ng tin c√° nh√¢n</h2>
            <div class="info-item" th:if="${canViewEmail}">
                <strong>Email:</strong> <span th:text="${user.email}">email@example.com</span>
            </div>
            <div class="info-item" th:if="${canViewPhone}">
                <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span th:text="${user.phone}">0123456789</span>
            </div>
            <div class="info-item" th:if="${canViewDob}">
                <strong>Sinh nh·∫≠t:</strong> <span th:text="${user.dateOfBirth}">01/01/1990</span>
            </div>
            <div class="info-item" th:if="${canViewBio}">
                <strong>Gi·ªõi thi·ªáu:</strong><br>
                <textarea readonly rows="5" style="width: 100%;" th:text="${user.bio}">...</textarea>
            </div>
            <div th:if="${isOwner}" class="profile-actions">
                <a th:href="@{/setting}" class="btn">Ch·ªânh s·ª≠a h·ªì s∆°</a>
            </div>
        </div>

        <div class="card-box profile-content" th:if="${canViewFriendList or mutualFriendsCount>0}">
            <h2>Th√¥ng tin b·∫°n b√®</h2>
            <div th:if="${canViewFriendList}">
                B·∫°n b√®: <span th:text="${friendCount}"></span>
            </div>
            <div th:if="${!isOwner and mutualFriendsCount>0}">
                B·∫°n chung: <span th:text="${mutualFriendsCount}"></span>
            </div>
            <div class="row">
                <div class="col-md-4" th:each="friend, iterStat : ${friends}" th:if="${iterStat.index} < 9">
                    <th:block
                            th:insert="~{fragments/friendCard :: friendCard(friend=${friend}, nameClass='name-profile')}">
                    </th:block>
                </div>
            </div>
        </div>
    </div>

    <!-- C·ªòT PH·∫¢I: N·ªôi dung d·ª±a tr√™n filter -->
    <div class="card-box posts-container" th:if="${filter == 'posts'}" >
        <!-- Post Creator cho ch·ªß trang -->
        <div th:if="${isOwner}" class="post-creator mb-4">
            <h3 class="post-title">
                <i class="fas fa-pen"></i> Chia s·∫ª suy nghƒ©
            </h3>
            <form id="profile-post-form" enctype="multipart/form-data">
                <div class="post-creator-header">
                    <img th:src="${user.profilePicture ?: '/images/default-avatar.jpg'}"
                         alt="Avatar" class="creator-avatar">

                    <div class="creator-info">
                        <span th:text="${user.firstName + ' ' + user.lastName}">T√™n ng∆∞·ªùi d√πng</span>
                        <select name="privacyLevel" class="privacy-select">
                            <option value="PUBLIC">üåç C√¥ng khai</option>
                            <option value="FRIENDS">üë• B·∫°n b√®</option>
                            <option value="PRIVATE">üîí Ch·ªâ m√¨nh t√¥i</option>
                        </select>
                    </div>
                </div>

                <textarea name="content" class="form-control post-content-input" rows="3"
                          placeholder="B·∫°n ƒëang nghƒ© g√¨?" required></textarea>

                <!-- Image preview area -->
                <div id="profile-image-preview-container" class="image-preview-container" style="display: none;">
                    <div id="profile-image-preview-list" class="image-preview-list"></div>
                </div>

                <div class="post-options">
                    <div class="post-actions-left">
                        <label for="profile-image-input" class="action-btn">
                            <i class="fas fa-image"></i> ·∫¢nh
                        </label>
                        <input type="file" id="profile-image-input" name="images" accept="image/*" multiple style="display: none;">
                    </div>
                    <button type="submit" class="btn btn-primary post-btn" id="profile-post-submit-btn" disabled>
                        <i class="fas fa-paper-plane"></i> ƒêƒÉng
                    </button>
                </div>
            </form>
        </div>

        <!-- Posts Feed -->
        <div id="profile-posts-container" th:data-username="${user.username}">
            <!-- Posts will be loaded here dynamically -->
        </div>

        <!-- Loading indicator -->
        <div id="profile-loading-indicator" class="text-center py-3" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
        </div>

        <!-- No posts message -->
        <div id="profile-no-posts" class="text-center py-5 text-muted" style="display: none;">
            <div class="mb-3">
                <i class="fas fa-edit fa-3x"></i>
            </div>
            <h5>Ch∆∞a c√≥ b√†i vi·∫øt n√†o</h5>
            <p th:if="${isOwner}">H√£y chia s·∫ª suy nghƒ© ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
            <p th:unless="${isOwner}" th:text="${user.firstName + ' ch∆∞a ƒëƒÉng b√†i vi·∫øt n√†o.'}"></p>
        </div>
    </div>

    <!-- Photos tab -->
    <div class="card-box posts-container" th:if="${filter == 'photos'}" >
        <h2>·∫¢nh</h2>
        <div id="profile-photos-container" th:data-username="${user.username}">
            <!-- Photos will be loaded here -->
        </div>

        <div id="photos-loading" class="text-center py-3" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
        </div>

        <div id="no-photos" class="text-center py-5 text-muted" style="display: none;">
            <div class="mb-3">
                <i class="fas fa-camera fa-3x"></i>
            </div>
            <h5>Ch∆∞a c√≥ ·∫£nh n√†o</h5>
            <p th:if="${isOwner}">H√£y th√™m ·∫£nh v√†o b√†i vi·∫øt ƒë·ªÉ hi·ªÉn th·ªã t·∫°i ƒë√¢y!</p>
            <p th:unless="${isOwner}" th:text="${user.firstName + ' ch∆∞a c√≥ ·∫£nh n√†o.'}"></p>
        </div>
    </div>

    <!-- B·∫°n b√® -->
    <div class="card-box profile-content" th:if="${filter == 'all' or filter == 'mutual' }">
        <input type="hidden" id="targetUserId" th:value="${targetUserId}"/>
        <input type="hidden" id="filterValue" th:value="${filter}"/>
        <div class="row" id="friends-list">
            <div class="col-md-3" th:each="friend : ${friends}">
                <th:block
                        th:insert="~{fragments/friendCard :: friendCard(friend=${friend}, nameClass='name-list-friend')}">
                </th:block>
            </div>
        </div>
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
        </div>
    </div>
</div>

<!-- Post Search Modal (for posts tab) -->
<div class="modal fade" id="searchPostsModal" tabindex="-1" th:if="${filter == 'posts' and isOwner}">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search"></i> T√¨m ki·∫øm b√†i vi·∫øt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="post-search-input" class="form-control"
                           placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm...">
                </div>
                <div id="search-results-container">
                    <!-- Search results will appear here -->
                </div>
                <div id="search-loading" class="text-center py-3" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> ƒêang t√¨m ki·∫øm...
                </div>
                <div id="no-search-results" class="text-center py-3 text-muted" style="display: none;">
                    <i class="fas fa-search"></i> Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Post Modal (reuse from news-feed) -->
<div class="modal fade" id="editPostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªânh s·ª≠a b√†i vi·∫øt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="edit-post-form">
                <div class="modal-body">
                    <input type="hidden" id="edit-post-id">

                    <div class="mb-3">
                        <label>Quy·ªÅn ri√™ng t∆∞:</label>
                        <select id="edit-privacy-level" class="form-select">
                            <option value="PUBLIC">üåç C√¥ng khai</option>
                            <option value="FRIENDS">üë• B·∫°n b√®</option>
                            <option value="PRIVATE">üîí Ch·ªâ m√¨nh t√¥i</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <textarea id="edit-content" class="form-control" rows="4" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label>·∫¢nh hi·ªán t·∫°i:</label>
                        <div id="edit-existing-images" class="existing-images-container"></div>
                    </div>

                    <div class="mb-3">
                        <label for="edit-new-images" class="form-label">Th√™m ·∫£nh m·ªõi:</label>
                        <input type="file" id="edit-new-images" class="form-control" accept="image/*" multiple>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add search button for posts tab -->
<div th:if="${filter == 'posts' and isOwner}" class="floating-search-btn">
    <button class="btn btn-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#searchPostsModal">
        <i class="fas fa-search"></i>
    </button>
</div>

<script th:src="@{/js/posts.js}"></script>
<script th:src="@{/js/profile-posts.js}"></script>
<script th:src="@{/js/load-friend.js}"></script>
<script th:src="@{/js/friend-button.js}"></script>

<style>
    .floating-search-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }

    .floating-search-btn button {
        width: 56px;
        height: 56px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    #profile-photos-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 20px;
    }

    .photo-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .photo-item:hover {
        transform: scale(1.02);
    }

    .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    @media (max-width: 768px) {
        .floating-search-btn {
            bottom: 80px; /* Account for mobile navigation */
        }

        #profile-photos-container {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
    }
</style>

</body>
</html>