<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${user.firstName + ' ' + user.lastName + ' | Hồ sơ cá nhân'}">Trang cá nhân</title>
    <link rel="stylesheet" th:href="@{/css/view_profile.css}">
    <th:block th:replace="~{fragments/commonHead :: commonHead}"></th:block>
</head>
<body>

<!-- HEADER -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- COVER IMAGE + AVATAR -->
<div class="cover-container">
    <img class="cover-image" th:src="@{/images/default-avatar.jpg}" alt="Ảnh bìa">

    <div class="avatar-container">
        <img class="avatar"
             th:if="${user.profilePicture != null and !#strings.isEmpty(user.profilePicture)}"
             th:src="@{${user.profilePicture}}" alt="Avatar">

        <img class="avatar"
             th:unless="${user.profilePicture != null and !#strings.isEmpty(user.profilePicture)}"
             th:src="@{/images/default-avatar.jpg}" alt="Avatar">

        <div class="user-name" th:text="${user.firstName + ' ' + user.lastName}">Tên người dùng</div>

        <div class="button-group" th:if="${!isOwner}">
            <div id="acceptedBtnGroup" th:classappend="${friendshipStatus != 'ACCEPTED'} ? 'd-none'" class="dropdown">
                <button class="btn btn-success dropdown-toggle" type="button" id="friendDropdownBtn"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-user-check"></i> Bạn bè
                </button>
                <ul class="dropdown-menu" aria-labelledby="friendDropdownBtn">
                    <li>
                        <button class="btn btn-danger" id="deleteFriendBtn" th:data-username="${user.username}">
                            <i class="fa-solid fa-user-xmark"></i> Hủy kết bạn
                        </button>
                    </li>
                </ul>
            </div>


            <div id="pendingBtnGroup"
                 th:classappend="${friendshipStatus != 'PENDING'} ? 'd-none'">
                <div th:if="${isSender}">
                    <button class="btn btn-warning" id="cancelFriendRequestBtn" th:data-username="${user.username}">
                        <i class="fa-solid fa-user-minus"></i> Hủy lời mời
                    </button>
                </div>
                <div th:if="${isReceiver}">
                    <button class="btn btn-success" id="acceptFriendBtn" th:data-username="${user.username}">
                        <i class="fa-solid fa-user-check"></i> Chấp nhận
                    </button>
                    <button class="btn btn-danger" id="reflectFriendBtn" th:data-username="${user.username}">
                        <i class="fa-solid fa-user-xmark"></i> Từ chối
                    </button>
                </div>
            </div>

            <div id="noneBtnGroup"
                 th:classappend="${friendshipStatus != 'NONE' or !allowFriendRequests} ? 'd-none'">
                <button class="btn btn-success" id="addFriendBtn" th:data-username="${user.username}">
                    <i class="fa-solid fa-user-plus"></i> Thêm bạn
                </button>
            </div>
            <button th:if="${canSendMessage}" class="btn btn-primary"><i class="fa-solid fa-message"></i> Nhắn tin
            </button>
        </div>

    </div>
</div>


<!-- NAVIGATION TABS -->
<div class="profile-tabs">
    <a href="#" class="tab active">Giới thiệu</a>
    <a href="#" class="tab">Bài viết</a>
    <a href="#" class="tab">Ảnh</a>
    <a href="#" class="tab">Bạn bè</a>
</div>

<!-- MAIN CONTENT: 2 CỘT -->
<div class="profile-page-container d-flex">

    <!-- CỘT TRÁI: Thông tin người dùng -->
    <div class="profile-left-column">
        <div class="profile-content">
            <h2>Thông tin cá nhân</h2>
            <div class="info-item" th:if="${canViewEmail}">
                <strong>Email:</strong> <span th:text="${user.email}">email@example.com</span>
            </div>
            <div class="info-item" th:if="${canViewPhone}">
                <strong>Số điện thoại:</strong> <span th:text="${user.phone}">0123456789</span>
            </div>
            <div class="info-item" th:if="${canViewDob}">
                <strong>Sinh nhật:</strong> <span th:text="${user.dateOfBirth}">01/01/1990</span>
            </div>
            <div class="info-item" th:if="${canViewBio}">
                <strong>Giới thiệu:</strong><br>
                <textarea readonly rows="5" style="width: 100%;" th:text="${user.bio}">...</textarea>
            </div>


            <div th:if="${isOwner}" class="profile-actions">
                <a th:href="@{/setting}" class="btn">Chỉnh sửa hồ sơ</a>
            </div>
        </div>

        <div class="profile-content" th:if="${canViewFriendList}">
            <h2>Thông tin bạn bè</h2>
            <div>
                Bạn bè: <span th:text="${friendCount}"></span>
            </div>
            <div th:if="${!isOwner and mutualFriendsCount>0}">
                Bạn chung: <span th:text="${mutualFriendsCount}"></span>
            </div>
            <div class="friend-container">
                <div th:each="friend : ${friends}">
                    <a th:href="@{/profile/{username}(username=${friend.username})}"
                       class="friend-card text-decoration-none">
                        <!-- Avatar: nếu có -->
                        <img th:if="${friend.avatarUrl != null and !#strings.isEmpty(friend.avatarUrl)}"
                             th:src="@{${friend.avatarUrl}}"
                             class="friend-avatar"
                             alt="Avatar">

                        <!-- Avatar mặc định -->
                        <img th:unless="${friend.avatarUrl != null and !#strings.isEmpty(friend.avatarUrl)}"
                             th:src="@{/images/default-avatar.jpg}"
                             class="friend-avatar"
                             alt="Avatar mặc định">

                        <!-- Tên người bạn -->
                        <div class="friend-name" th:title="${friend.fullName}" th:text="${friend.fullName}">Friend
                            Name
                        </div>
                    </a>
                </div>
            </div>
        </div>

    </div>

    <!-- CỘT PHẢI: Bài viết -->
    <div class="posts-container">
        <h2>Bài viết</h2>

        <div th:if="${posts.isEmpty()}">
            <p>Chưa có bài viết nào.</p>
        </div>

        <div th:each="post : ${posts}" class="post-card">
            <div class="post-header">
                <img class="post-avatar"
                     th:src="@{${user.profilePicture != null && !#strings.isEmpty(user.profilePicture) ? user.profilePicture : '/images/default-avatar.jpg'}}"
                     alt="Avatar">

                <div class="post-user-info">
                    <div class="post-username" th:text="${user.firstName + ' ' + user.lastName}">Tên người dùng</div>
                    <div class="post-time" th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">Ngày
                        đăng
                    </div>
                </div>
            </div>

            <div class="post-content" th:text="${post.content}">
                Nội dung bài viết...
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const addFriendBtn = document.getElementById("addFriendBtn");
        const cancelFriendRequestBtn = document.getElementById("cancelFriendRequestBtn");
        const reflectFriendBtn = document.getElementById("reflectFriendBtn");
        const deleteFriendBtn = document.getElementById("deleteFriendBtn");
        const acceptFriendBtn = document.getElementById("acceptFriendBtn");
        const noneBtnGroup = document.getElementById("noneBtnGroup");
        const pendingBtnGroup = document.getElementById("pendingBtnGroup");
        const acceptedBtnGroup = document.getElementById("acceptedBtnGroup");

        function toggleButtons(showGroup) {
            [noneBtnGroup, pendingBtnGroup, acceptedBtnGroup].forEach(group => {
                if (group) group.classList.add("d-none");
            });
            if (showGroup) showGroup.classList.remove("d-none");
        }

        if (addFriendBtn) {
            addFriendBtn.addEventListener("click", function () {
                const username = this.getAttribute("data-username");
                fetch('/addFriend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({user_name: username})
                })
                    .then(response => {
                        if (response.ok) {
                            toggleButtons(pendingBtnGroup); // Hiện Hủy lời mời
                        } else {
                            alert("Có lỗi xảy ra khi gửi lời mời!");
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi:', error);
                        alert("Không thể gửi lời mời.");
                    });
            });
        }

        if (acceptFriendBtn) {
            acceptFriendBtn.addEventListener("click", function () {
                const username = this.getAttribute("data-username");

                fetch('/acceptFriend', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        user_name: username
                    })
                })
                    .then(response => {
                        if (response.ok) {
                            // ✅ Cập nhật UI sau khi chấp nhận
                            toggleButtons(acceptedBtnGroup);
                        } else {
                            alert("Có lỗi xảy ra khi chấp nhận lời mời!");
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi:', error);
                        alert("Không thể chấp nhận.");
                    });
            });
        }

        // Gộp logic hủy / từ chối / xóa kết bạn
        [cancelFriendRequestBtn, reflectFriendBtn, deleteFriendBtn].forEach(btn => {
            if (btn) {
                btn.addEventListener("click", function () {
                    const username = this.getAttribute("data-username");
                    fetch('/deleteFriend', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({user_name: username})
                    })
                        .then(response => {
                            if (response.ok) {
                                toggleButtons(noneBtnGroup); // Hiện "Thêm bạn"
                            } else {
                                alert("Có lỗi xảy ra khi XÓA BẠN!");
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi:', error);
                            alert("Không thể xóa.");
                        });
                });
            }
        });
    });
</script>

</body>
</html>
